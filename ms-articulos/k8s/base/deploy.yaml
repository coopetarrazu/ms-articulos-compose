apiVersion: apps/v1
kind: Deployment
metadata:
  name: ms-articulo-compose-deploy
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ms-articulo-compose
  template:
    metadata:
      labels:
        app: ms-articulo-compose
    spec:
      containers:
        - name: ms-articulo-compose
          image: 10.1.10.13:5000/ms-articulos:v1.0.0

          # ðŸ”µ Ejecutar importaciÃ³n de certificados antes de iniciar la app
          command: ["sh", "-c"]
          args:
            - |
              echo "ðŸ“Œ Importando certificados SSL..."

              # Importar certificado del dominio
              keytool -importcert \
                -file /opt/certs/cert.crt \
                -alias cert-coopetarrazu \
                -keystore $JAVA_HOME/lib/security/cacerts \
                -storepass changeit \
                -noprompt ;

              # Importar CA raÃ­z
              keytool -importcert \
                -file /opt/certs/ca-root.crt \
                -alias ca-root-coopetarrazu \
                -keystore $JAVA_HOME/lib/security/cacerts \
                -storepass changeit \
                -noprompt ;

              echo "ðŸš€ Iniciando microservicio..." ;
              java -jar app.jar

          envFrom:
            - configMapRef:
                name: ms-config

          ports:
            - containerPort: 80

          imagePullPolicy: Always

          volumeMounts:
            # ðŸ”µ Monta TODOS los certificados del ConfigMap en la carpeta
            - name: cert-prod-coopetarrazu
              mountPath: /opt/certs

      volumes:
        # ðŸ”µ ConfigMap con ambos certificados
        - name: cert-prod-coopetarrazu
          configMap:
            name: cert-prod-coopetarrazu
